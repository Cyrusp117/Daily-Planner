<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    {% load static %}
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src='{% static 'lib/moment.min.js' %}'></script>
    <script src='{% static 'moment-timezone-with-data.js' %}'></script>
    
    <title>Document</title>
</head>
<style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
          height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
        div.res_box {
          width: 300px;
          border: 25px solid rgb(8, 139, 52);
          padding: 25px;
        }
      </style>
    </head>
    <body>
      <div id="map"></div>
      <ol id="restaurants">

      </ol>
      <script>
          // Client ID and API key from the Developer Console
  var CLIENT_ID = '777718038660-mg1cq9kfcrt0fq4lrk681d9ualvcgrp1.apps.googleusercontent.com';
  var API_KEY = 'AIzaSyAB7Zfk1cIw5ejq6x8Kol3qwNCv7R0NTJg';

  // Array of API discovery doc URLs for APIs used by the quickstart
  var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
  // Authorization scopes required by the API; multiple scopes can be
  // included, separated by spaces.
  var SCOPES = "https://www.googleapis.com/auth/calendar";
        // Note: This example requires that you consent to location sharing when
        // prompted by your browser. If you see the error "The Geolocation service
        // failed.", it means you probably did not give permission for the browser to
        // locate you.
        var map, infoWindow;
        function handleClientLoad() {
          // Loads the client library and the auth2 library together for efficiency.
          // Loading the auth2 library is optional here since `gapi.client.init` function will load
          // it if not already loaded. Loading it upfront can save one network request.
          gapi.load('client:auth2', Initialize);
        }
      function Initialize() {
          // 2. Initialize the JavaScript client library.
          gapi.client.init({
            'apiKey': API_KEY,
            // Your API key will be automatically added to the Discovery Document URLs.
            'discoveryDocs': DISCOVERY_DOCS,
            // clientId and scope are optional if auth is not required.
            'clientId': CLIENT_ID,
            'scope': SCOPES,
          }).then(function () {
            initMap();
          });
      };
        function callback(results, status) {
            if (status == google.maps.places.PlacesServiceStatus.OK) {
              for (var i = 0; i < results.length; i++) {
                var place = results[i];
                createMarker(results[i]);
                // create a list of info
                addrestaurant(place);
              }
              console.log(results);
              return results;
            }
          }
          function addrestaurant(restaurant){
            var x = document.createElement("DIV");
            x.className = "res_box";
            var t = document.createTextNode(restaurant.name);
            x.appendChild(t);
            if(restaurant.photos){
              var i = document.createElement("IMG");
              i.setAttribute("src", restaurant.photos[0].getUrl({'maxWidth': 50, 'maxHeight': 50}));
              i.setAttribute("alt", restaurant.name);
              x.appendChild(i);
            }
            var rating = document.createTextNode("Google Rating:  " + restaurant.rating);
            

            //.getUrl({'maxWidth': 35, 'maxHeight': 35})
            var loc = document.createTextNode(restaurant.vicinity);
            x.appendChild(document.createElement("br"));
            x.appendChild(loc);
            x.appendChild(document.createElement("br"));
            x.appendChild(rating);
            document.body.appendChild(x);
            document.getElementById("restaurants").appendChild(x);
          }
          
        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: -34.397, lng: 150.644},
            zoom: 15
          });
          infoWindow = new google.maps.InfoWindow;
  
          // Try HTML5 geolocation.
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
  
              infoWindow.setPosition(pos);
              infoWindow.setContent('Location found.');
              infoWindow.open(map);
              map.setCenter(pos);
              var request = {
                location: pos,
                radius: '500',
                type: ['restaurant']
              };
            console.log(request);
            searchIfMealtime(map, request);
              
            }, function() {
              handleLocationError(true, infoWindow, map.getCenter());
            });
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
          }
        }
        function searchIfMealtime(map, loc){
          var request = gapi.client.calendar.events.list({
            'calendarId': 'primary',
            'timeMin':  moment().format(),
            'timeMax':  moment().add(1, 'hours').format(),
            'privateExtendedProperty' : 'type = mealtime' 
          });
          request.execute(function(response){
            console.log(response);
            if(response){
              if(response.items[0].extendedProperties.private.type === 'mealtime'){
                service = new google.maps.places.PlacesService(map);
                service.nearbySearch(loc, callback);
              } 
            }
          });
        }
        
        function createMarker(place) {
          var photos = place.photos;
          if (!photos) {
            new google.maps.Marker({
              position: place.geometry.location,
              map: map
            });
            return;
          }
        
          var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            title: place.name,
          });
        }
        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
          infoWindow.setPosition(pos);
          infoWindow.setContent(browserHasGeolocation ?
                                'Error: The Geolocation service failed.' :
                                'Error: Your browser doesn\'t support geolocation.');
          infoWindow.open(map);
        }
       
      </script>
  
        <script async defer
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAB7Zfk1cIw5ejq6x8Kol3qwNCv7R0NTJg&libraries=places&callback=handleClientLoad">
        </script>
</body>

</html>