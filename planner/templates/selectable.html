<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />


{% load static %}
<link href='{% static 'fullcalendar.css' %}' rel='stylesheet' />
<link href='{% static 'fullcalendar.print.css' %}' rel='stylesheet' media='print' />
<script src='{% static 'lib/moment.min.js' %}'></script>
<script src='{% static 'lib/jquery.min.js' %}'></script>
<script src='{% static 'fullcalendar.js' %}'></script>
<script src='{% static 'moment-timezone-with-data.js' %}'></script>
<script type='text/javascript' src='{% static 'gcal.js' %}'></script>

<script src="https://apis.google.com/js/platform.js" async defer></script>
<meta name="google-signin-client_id" content="777718038660-ob329re48n6vapuo4ebah4ssq5gdqrvn.apps.googleusercontent.com">
<script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
<script>
  var primaryevents = [];//the events array of primary calendar

  // Client ID and API key from the Developer Console
  var CLIENT_ID = '777718038660-mg1cq9kfcrt0fq4lrk681d9ualvcgrp1.apps.googleusercontent.com';
  var API_KEY = 'AIzaSyAB7Zfk1cIw5ejq6x8Kol3qwNCv7R0NTJg';

  // Array of API discovery doc URLs for APIs used by the quickstart
  var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

  // Authorization scopes required by the API; multiple scopes can be
  // included, separated by spaces.
  var SCOPES = "https://www.googleapis.com/auth/calendar";
  function handleClientLoad() {
    // Loads the client library and the auth2 library together for efficiency.
    // Loading the auth2 library is optional here since `gapi.client.init` function will load
    // it if not already loaded. Loading it upfront can save one network request.
    gapi.load('client:auth2', start);
  }
  function start() {
    // 2. Initialize the JavaScript client library.
    gapi.client.init({
      'apiKey': API_KEY,
      // Your API key will be automatically added to the Discovery Document URLs.
      'discoveryDocs': DISCOVERY_DOCS,
      // clientId and scope are optional if auth is not required.
      'clientId': CLIENT_ID,
      'scope': SCOPES,
    }).then(function () {
      // Listen for sign-in state changes.
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
      // Handle the initial sign-in state.
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
    }).then(function() {
      // 3. Initialize and make the API request.
      return gapi.client.request({
        'path' : 'https://www.googleapis.com/calendar/v3/calendars/primary/events',
      })
    }).then(function(response) {
      primaryevents = response.result;
      console.log(response.result);
    }, function(reason) {
      console.log('Error: ');
    });
  };
  
  function updateSigninStatus(isSignedIn) {
    // When signin status changes, this function is called.
    // If the signin status is changed to signedIn, we make an API call.
    if (isSignedIn) {
      listUpcomingEvents();
    }
  }

  function handleSignInClick(event) {
    // Ideally the button should only show up after gapi.client.init finishes, so that this
    // handler won't be called before OAuth is initialized.
    gapi.auth2.getAuthInstance().signIn();
    handleClientLoad()
  }

  function handleSignOutClick(event) {
    gapi.auth2.getAuthInstance().signOut();
    handleClientLoad()
  }

  /**
    * Print the summary and start datetime/date of the next ten events in
    * the authorized user's calendar. If no events are found an
    * appropriate message is printed.
    */
  function listUpcomingEvents() {
    gapi.client.calendar.events.list({
      'calendarId': 'primary',
      'timeMin': (new Date()).toISOString(),
      'showDeleted': false,
      'singleEvents': true,
      'maxResults': 10,
      'orderBy': 'startTime'
    }).then(function(response) {
      var events = response.result.items;
      appendPre('Upcoming events:');

      if (events.length > 0) {
        for (i = 0; i < events.length; i++) {
          var event = events[i];
          var when = event.start.dateTime;
          if (!when) {
            when = event.start.date;
          }
          appendPre(event.summary + ' (' + when + ')')
        }
      } else {
        appendPre('No upcoming events found.');
      }
    });
  }
  function appendPre(message) {
    var pre = document.getElementById('content');
    var textContent = document.createTextNode(message + '\n');
    pre.appendChild(textContent);
  }

  $(document).ready(function() {

    $('#calendar').fullCalendar({
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,agendaWeek,agendaDay'
      },
      defaultDate: '2018-03-12', // TODO change it to current day
      navLinks: true, // can click day/week names to navigate views
      selectable: true,
      selectHelper: true,
      select: function(start, end) {
        var modal = document.getElementById('myModal');
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        var title = document.getElementById("eventTitle");
        var save = document.getElementById("Save");
        var cancel = document.getElementById("Cancel");
        var del = document.getElementById("Delete");
        modal.style.display = "block";        
        // When the user clicks on <span> (x), close the modal
        var newEvent = new Object(); 
        newEvent.title = title.value;          
        newEvent.start = start;
        newEvent.end = end;
        newEvent.allDay = start._ambigTime;//determine if it's an all day event
        $('#calendar').fullCalendar('renderEvent', newEvent);
        span.onclick = function() {
          $('#calendar').fullCalendar('refetchEvents');
          modal.style.display = "none";
        }
        cancel.onclick = function() {
          $('#calendar').fullCalendar('refetchEvents');
          modal.style.display = "none";
        }

        del.onclick = function() {
          $('#calendar').fullCalendar('refetchEvents');
          modal.style.display = "none";
        }

        save.onclick = function() {
          if(title.value){
            newEvent.title = title.value;          
          }
          else{
            newEvent.title = "No title";
          }
          $('#calendar').fullCalendar('refetchEvents');
          insertEvent(newEvent);
          modal.style.display = "none";
        }
        $('#calendar').fullCalendar('unselect');
        title.value = "";
      },
      eventClick: function(calEvent, jsEvent, view) {
       
        var modal = document.getElementById('myModal');
        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];
        var title = document.getElementById("eventTitle");
        var save = document.getElementById("Save");
        var cancel = document.getElementById("Cancel");
        var del = document.getElementById("Delete");
       
        title.value = calEvent.title;
        modal.style.display = "block";        
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
          modal.style.display = "none";
          title.value = "";
        }
        cancel.onclick = function() {
          modal.style.display = "none";
          title.value = "";
        }
        del.onclick = function() {
          deleteEvent(calEvent);
          modal.style.display = "none";
          title.value = "";
        }
        save.onclick = function() {
          var oldEvent = new Object();
          oldEvent = calEvent;
          calEvent.title = title.value;
          deleteEvent(oldEvent);       
          insertEvent(calEvent);
          modal.style.display = "none";
          title.value = "";
        }
        // change the border color just for fun
        $(this).css('border-color', 'red');
    
      },
      eventDrop: function(event, delta, revertFunc)  {
        updateEvent(event);
      },
      eventResize: function(event, delta, revertFunc) {
        updateEvent(event);
      },
      editable: true,
      eventLimit: true, // allow "more" link when too many events
      googleCalendarApiKey: 'AIzaSyAB7Zfk1cIw5ejq6x8Kol3qwNCv7R0NTJg',
      events: {
        googleCalendarId: 'en-gb.australian#holiday@group.v.calendar.google.com',
        editable: false,
        color: 'green'
      },
      color: 'black',     // an option!
      textColor: 'yellow' // an option!
    });

  });
  var handleSyncEvents = (function () {
    var executed = false;
    return function() {
      if (!executed) {
        executed = true;
        var items = primaryevents.items;
        events = []; // put the array in the `events` property    
        for(i = 0;i < items.length; i++)
        { 
          var event = new Object();
          event.id = items[i].id,
          event.title = items[i].summary,
          event.start =  items[i].start.dateTime,
          event.end =  items[i].end.dateTime;
          if(!event.start){//all day event
            event.start = items[i].start.date,
            event.end =  items[i].end.date
          }
          //dealing recurrent
          {% comment %} if(items[i].recurrence){
            event.dow=[];
            var recu = items[i].recurrence[0];
            var repeat = recu.split(/[=;]+/)
            console.log(repeat)
            if(repeat[1] === 'DAILY'){
              event.dow = [1,2,3,4,5,6,7];
            }
            else if(repeat[1] === 'WEEKLY'){
              var repdayarr = repeat[3].split(",");
              for(j = 0;j < repdayarr.length; j++){
                switch(repdayarr[j]){
                  case "MO":
                    event.dow.push(1);break;
                  case "TU":
                    event.dow.push(2);break;
                  case "WE":
                    event.dow.push(3);break;
                  case "TH":
                    event.dow.push(4);break;
                  case "FR":
                    event.dow.push(5);break;
                  case "SA":
                    event.dow.push(6);break;
                  case "SU":
                    event.dow.push(7);break;     
                }
              }
            }
            console.log(event.dow )
          } {% endcomment %}
          events.push(event);
        };
        console.log(events);
        $('#calendar').fullCalendar('renderEvents' , events,true);
        arr = $('#calendar').fullCalendar('clientEvents');
        console.log(arr);
      }
    };
    
  })();

  //update an existing event
  function updateEvent(event) {
    var desc;
    var location;
    var eventToSave = {};
    if (event.placeID) {
        location = event.placeID; // formatted address for gCal
        // placeID is handled on google's end
    }
    if (event.description) {
        desc = event.description;
    }
    if (event.allDay) {
        eventToSave = {
            'summary': event.title,
            'location': location,
            'description': desc,
            'start': {
                'date': event.start.format("YYYY-MM-DD")
            },
            'end': {
                'date': event.end.format("YYYY-MM-DD")
            }
        };

    } else {
        eventToSave = {
            'summary': event.title,
            'location': location,
            'description': desc,
            'start': {
                'dateTime': event.start.local() ,
            },
            'end': {
                'dateTime': event.end.local(),
            }
        };
    }
    console.log(eventToSave);
    var request = gapi.client.calendar.events.update({
        'calendarId': 'primary',
        'eventId':event.id,
        'resource': eventToSave
    });
    request.execute(function(response) {
        if (!response) {
            console.log('error updating event');
            console.log(response);
        } else {
            console.log('event updated');
            console.log(response);
            $('#calendar').fullCalendar('updateEvent', event); // stick? = true                         
        }
    });
  }
  // saves event to eventArray 
  // used for both intial save and 
  // later edits to the event
  function insertEvent(event) {
    var desc;
    var location;
    var eventToSave = {};
    if (event.placeID) {
        location = event.placeID; // formatted address for gCal
        // placeID is handled on google's end
    }
    if (event.description) {
        desc = event.description;
    }
    if (event.allDay) {
        eventToSave = {
            'summary': event.title,
            'location': location,
            'description': desc,
            'start': {
                'date': event.start.format("YYYY-MM-DD")
            },
            'end': {
                'date': event.end.format("YYYY-MM-DD")
            }
        };

    } else {
        eventToSave = {
            'summary': event.title,
            'location': location,
            'description': desc,
            'start': {
                'dateTime': event.start.local() ,
            },
            'end': {
                'dateTime': event.end.local(),
            }
        };
    }
    console.log(eventToSave);
    var request = gapi.client.calendar.events.insert({
        'calendarId': 'primary',
        'resource': eventToSave
    });
    request.execute(function(response) {
        if (!response) {
            console.log('error inserting event');
            console.log(response);
        } else {
            console.log('event inserted');
            console.log(response);
            console.log(response.id);
            event.id = response.id;
            $('#calendar').fullCalendar('renderEvent', event,true); // stick? = true                         
        }
    });
  }
  // deletes event from users gcal
  // when it is dropped in the trashcan
  function deleteEvent(event) {
    var request = gapi.client.calendar.events.delete({
        'calendarId': 'primary',
        'eventId': event.id
    });

    request.execute(function(response) {
        if (!response) {
            console.log('event delete threw error');
            console.log(response);
        } else {
            console.log('event deleted');
            $('#calendar').fullCalendar('removeEvents', event.id);
        }
    });

  }
</script>

<style>
  /* The Modal (background) */
  .modal {
      display: none;
      position: fixed; /* Stay in place */
      z-index: 10; /* Sit on top */
      padding-top: 100px; /* Location of the box */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  }
  
  /* Modal Content */
  .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
  }
  
  /* The Close Button */
  .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
  }
  
  .close:hover,
  .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
  }
  </style>

<style>

  body {
    margin: 40px 10px;
    padding: 0;
    font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
    font-size: 14px;
  }

  #calendar {
    max-width: 900px;
    margin: 0 auto;
  }

</style>
</head>
<body>
  <script async defer src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
  <button id="signin-button" onclick="handleSignInClick()">Sign In</button>
  <button id="signout-button" onclick="handleSignOutClick()">Sign Out</button>
  <button id="sync-events" onclick="handleSyncEvents()">Sync Google Calendar</button>
  <pre id="content"></pre>

<!-- The Modal -->
<div id="myModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>Event is</p>
    <input id="eventTitle" type="text" name = "Title" >
    <input type="button" id="Save" value="Save" >
    <input type="button" id="Cancel" value="Cancel" >
    <input type="button" id="Delete" value="Delete" >
    <a href="edittask">More Options</a>
  </div>
</div>

  <div id='calendar'></div>
</div>
</body>
</html>
