<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	{% load static %}
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Home - Easy Planner</title>

	<link href='{% static 'fullcalendar.css' %}' rel='stylesheet' />
	<link href='{% static 'fullcalendar.print.css' %}' rel='stylesheet' media='print' />
	<script src='{% static 'lib/moment.min.js' %}'></script>
	<script src='{% static 'lib/jquery.min.js' %}'></script>
	<script src='{% static 'fullcalendar.js' %}'></script>
	<script src='{% static 'moment-timezone-with-data.js' %}'></script>
	<script type='text/javascript' src='{% static 'gcal.js' %}'></script>

	<!-- Google API scripts -->
	<link href='{% static 'styles.css' %}' rel='stylesheet'/>
	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<meta name="google-signin-client_id" content="777718038660-ob329re48n6vapuo4ebah4ssq5gdqrvn.apps.googleusercontent.com">
	<script src="https://apis.google.com/js/api.js"></script>
	<script src='{% static 'connectGoogle.js' %}'></script>
	

	<style type="text/css" >
		html, body {
			margin: 0px;
			padding: 0px;
			height: 100%;
		}
				/* Always set the map height explicitly to define the size of the div
			* element that contains the map. */
		div.res_box {
			width: 380px;
			height:100px;
			border: 1px solid rgb(206, 204, 204);
			box-shadow: 1px 1px rgb(219, 219, 219);
		}
		div.res_box:hover {
			background-color: rgb(214, 214, 214);
		}
		div.task_box{
			float:left;
			width:50%;
			display: block;
		}
		div.resta_holder{
			overflow: scroll;
			height: 300px;
			width: 400px;
			border: 1px solid rgba(245, 245, 245, 0.911);
			box-shadow: 1px 2px whitesmoke;
		}
	</style>

</head>
  <body>
	<img src="{% static "images/logo.png" %}" alt="Easy Planner" class="center" style='width:251px;'>
	<br>
	<div style="text-align:center;"> <!-- nav bar here? -->

	</div>
	<br>
	<!-- TODO put weather api into homepage -->
	<div class="task_box" >
			<pre id="upcoming" style="border-bottom:1px black solid;padding-bottom:5px;"></pre>
			<div id="restaurants_box" >
					<div id="re_map" style="height:150px; width: 400px;"></div>
					<div id="restaurants" class="resta_holder" > </div>
			</div>
			
			<pre id="content"></pre>
	</div>


	<div style="border-left:1px black solid;background-color:#afe2ff;display:inline;float:right;width:45%;">
		
		<div id="weather">
			<h2>Weather</h2>
			Stuff goes here
		</div>
		<div id="map">
			<h2>Map</h2>
			Stuff goes here
		</div>
	</div>

	<script type="text/javascript">
	  // Client ID and API key from the Developer Console
	  var CLIENT_ID = '777718038660-mg1cq9kfcrt0fq4lrk681d9ualvcgrp1.apps.googleusercontent.com';
	  var API_KEY = 'AIzaSyAB7Zfk1cIw5ejq6x8Kol3qwNCv7R0NTJg';

	  // Array of API discovery doc URLs for APIs used by the quickstart
	  var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

	  // Authorization scopes required by the API; multiple scopes can be
	  // included, separated by spaces.
	  var SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

		var map, currentloc;

	  /**
	   *  On load, called to load the auth2 library and API client library.
	   */
	  function handleClientLoad() {
	  	gapi.load('client:auth2', initClient);
	  }

	  /**
	   *  Initializes the API client library and sets up sign-in state
	   *  listeners.
	   */
	  function initClient() {
			gapi.client.init({
			apiKey: API_KEY,
			clientId: CLIENT_ID,
			discoveryDocs: DISCOVERY_DOCS,
			scope: SCOPES
	  }).then(function () {
				getNextEvent();
				listUpcomingEvents();
	  	});
	  }

	  /**
	   * Append a pre element to the body containing the given message
	   * as its text node. Used to display the results of the API call.
	   *
	   * @param {string} message Text to be placed in pre element.
	   */
	  function appendPre(message, content) {
			var pre = document.getElementById(content);
			var textContent = document.createTextNode(message + '\n');
			pre.appendChild(textContent);
	  }

	  /**
	   * Print the summary and start datetime/date of the next ten events in
	   * the authorized user's calendar. If no events are found an
	   * appropriate message is printed.
	   */
	  function listUpcomingEvents() {
	  gapi.client.calendar.events.list({
		'calendarId': 'primary',
		'timeMin': (new Date()).toISOString(),
		'showDeleted': false,
		'singleEvents': true,
		'maxResults': 11,
		'orderBy': 'startTime'
	  }).then(function(response) {
		var events = response.result.items;
		appendPre('Upcoming events:', 'content');

		if (events.length > 1) {
		  for (i = 1; i < events.length; i++) {
			var event = events[i];
			var when = event.start.dateTime;
			if (!when) {
			  when = event.start.date;
			}
			appendPre(event.summary + ' (' + when + ')', 'content')
		  }
		} else {
		  appendPre('No upcoming events found.', 'content');
		}
	  });
	  }

	  function getNextEvent() {
	  gapi.client.calendar.events.list({
		'calendarId': 'primary',
		'timeMin':  moment().format(),
    'timeMax':  moment().add(1, 'hours').format(),
	  }).then(function(response) {
		var events = response.result.items;
		appendPre('Up next:', 'upcoming');

		if (events.length > 0) {
			var event = events[0];
			var when = event.start.dateTime;
			if (!when) {
			  when = event.start.date;
			}
			appendPre(event.summary + ' (' + when + ')', 'upcoming');
			if (event.location)
				appendPre('    ' + event.location, 'upcoming');
			if (event.description) {
				appendPre('    ' + event.description, 'upcoming');
			}
			if(event.extendedProperties){
				if(event.extendedProperties.private.type === 'mealtime'){
					initMap();
				}
			}
		} else {
		  appendPre('No event now', 'upcoming');
		}
	  });
	  }

		function callback(results, status) {
			if (status == google.maps.places.PlacesServiceStatus.OK) {
				for (var i = 0; i < results.length; i++) {
					var place = results[i];
					createMarker(results[i]);
					// create a list of info
					addrestaurant(place);
				}
				console.log(results);
				return results;
			}
		}
		function addrestaurant(restaurant){
			var x = document.createElement("DIV");
			x.className = "res_box";
			var t = document.createTextNode(restaurant.name);
			var title = document.createElement("SPAN");
			title.style.fontFamily = '"Times New Roman", Times, serif';
			title.style.fontSize = '20px';
			title.style.fontStyle = 'italic';
			title.style.fontWeight = 'bold';
			title.appendChild(t);
			x.appendChild(title);
			if(restaurant.photos){
				var i = document.createElement("IMG");
				i.setAttribute("src", restaurant.photos[0].getUrl({'maxWidth': 100, 'maxHeight': 100}));
				i.setAttribute("alt", restaurant.name);
				i.style.float= 'right';
				x.appendChild(i);
			}
			var rating = document.createTextNode("Google Rating:  " + restaurant.rating);
			

			//.getUrl({'maxWidth': 35, 'maxHeight': 35})
			var loc = document.createTextNode(restaurant.vicinity);
			var loc_span = document.createElement("SPAN");
			loc_span.style.color = "grey";
			loc_span.style.fontSize = '10px';
			loc_span.style.fontStyle = 'italic';
			loc_span.appendChild(document.createElement("br"));
			loc_span.appendChild(loc);
			loc_span.appendChild(document.createElement("br"));
			loc_span.appendChild(rating);
			x.appendChild(loc_span)
			document.getElementById("restaurants").appendChild(x);
		}
		
	function initMap() {
		var restaurant_map = document.getElementById('re_map');
		console.log(restaurant_map);
		map = new google.maps.Map(restaurant_map), {
			center: {lat: -34.397, lng: 150.644},
			zoom: 15
		};
		console.log(map);
		


		// Try HTML5 geolocation.
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				};
				currentloc = new google.maps.Marker({
					position: pos,
					map: map
				});

				map.setCenter(pos);
				var request = {
					location: pos,
					radius: '500',
					type: ['restaurant']
				};
			console.log(request);
			searchIfMealtime(map, request);
				
			}, function() {
				handleLocationError(true, currentloc, map.getCenter());
			});
		} else {
			// Browser doesn't support Geolocation
			handleLocationError(false, currentloc, map.getCenter());
		}
	}
	function searchIfMealtime(map, loc){
		var request = gapi.client.calendar.events.list({
			'calendarId': 'primary',
			'timeMin':  moment().format(),
			'timeMax':  moment().add(1, 'hours').format(),
			'privateExtendedProperty' : 'type = mealtime' 
		});
		request.execute(function(response){
			console.log(response);
			if(response){
				if(response.items[0].extendedProperties.private.type === 'mealtime'){
					service = new google.maps.places.PlacesService(map);
					service.nearbySearch(loc, callback);
				} 
			}
		});
	}
	var map2;
	function createMarker(place) {
		var photos = place.photos;
		if (!photos) {
			new google.maps.Marker({
				position: place.geometry.location,
				map: map
			});
			return;
		}
	
		var marker = new google.maps.Marker({
			map: map,
			position: place.geometry.location,
			title: place.name,
		});
	}
	function handleLocationError(browserHasGeolocation, currentloc, pos) {
		currentloc.setPosition(pos);
		currentloc.setContent(browserHasGeolocation ?
													'Error: The Geolocation service failed.' :
													'Error: Your browser doesn\'t support geolocation.');
		currentloc.open(map);
	}
	</script>

	<script async defer
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAB7Zfk1cIw5ejq6x8Kol3qwNCv7R0NTJg&libraries=places&callback=handleClientLoad">
</script>
  </body>
</html>
