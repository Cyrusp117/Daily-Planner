<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="777718038660-ob329re48n6vapuo4ebah4ssq5gdqrvn.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js?onload=init" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    {% load static %}
    <script src='{% static 'connectGoogle.js' %}'></script>
    <link href='{% static 'fullcalendar.css' %}' rel='stylesheet' />
    <link href='{% static 'fullcalendar.print.css' %}' rel='stylesheet' media='print' />
    <script src='{% static 'lib/moment.min.js' %}'></script>
    <script src='{% static 'lib/jquery.min.js' %}'></script>
    <script src='{% static 'fullcalendar.js' %}'></script>
    <script src='{% static 'moment-timezone-with-data.js' %}'></script>
    <script type='text/javascript' src='{% static 'gcal.js' %}'></script>
    <title>Editing Task</title>
</head>
<script>
    
    function handleClientLoad() {
        // Loads the client library and the auth2 library together for efficiency.
        // Loading the auth2 library is optional here since `gapi.client.init` function will load
        // it if not already loaded. Loading it upfront can save one network request.
        gapi.load('client:auth2', Initialize);
    }
    function Initialize() {
        // 2. Initialize the JavaScript client library.
        gapi.client.init({
          'apiKey': API_KEY,
          // Your API key will be automatically added to the Discovery Document URLs.
          'discoveryDocs': DISCOVERY_DOCS,
          // clientId and scope are optional if auth is not required.
          'clientId': CLIENT_ID,
          'scope': SCOPES,
        }).then(function () {
            if(sessionStorage.getItem("eventexist")){//if event already exist, autofill the taskform
                autofillform();
            }
        });
    };
    function autofillform(){
        var taskfrm = document.forms["taskform"];  
        var eventId = sessionStorage.getItem("GeventId");
        getGevent(eventId,function(Gevent){
            console.log('huzzah, I\'m done!');
            taskfrm.taskTitle.value = Gevent.summary;
            if(Gevent.start.date){//if it's all day event
                taskfrm.all_day.checked = true;
                isallday();
                taskfrm.f_date.value = Gevent.start.date;
                taskfrm.t_date.value = Gevent.end.date;
                taskfrm.destination.value = Gevent.location;
            }
            else{
                taskfrm.all_day.checked = false;
                var startTime = Gevent.start.dateTime;
                var endTime = Gevent.end.dateTime;
                isallday();
                taskfrm.timezone = startTime.slice(startTime.indexOf("+"));
                taskfrm.f_date.value = startTime.slice(0,startTime.indexOf("T")) ;
                taskfrm.f_time.value = startTime.slice(1+startTime.indexOf("T"),startTime.indexOf("+")) ;
                taskfrm.t_date.value = endTime.slice(0,endTime.indexOf("T")) ;
                taskfrm.t_time.value = endTime.slice(1+endTime.indexOf("T"),endTime.indexOf("+")) ;
            }
            if(Gevent.location){
                taskfrm.destination.value = Gevent.location;
            }
            if(Gevent.description){
                taskfrm.description.value = Gevent.description;
            }
        });
    }
    function isallday(){
        var taskfrm = document.forms["taskform"];  
        if(taskfrm.all_day.checked){
            taskfrm.t_time.style.display = "none";    
            taskfrm.f_time.style.display = "none";     
        }
        else{
            taskfrm.t_time.style.display = "inline";    
            taskfrm.f_time.style.display = "inline";   
        }
    }
    function getGevent(eventId,_callback){
        var request = gapi.client.calendar.events.get({
            'calendarId': 'primary',
            'eventId':eventId,
        });
        request.execute(function(response) {
            if (!response) {
                console.log('error getting event');
                console.log(response);
            } else {
                console.log('event got');
                console.log(response);
                _callback(response);
            }
        });
        
    }
    function saveTask(){
        var taskfrm = document.forms["taskform"];  
        if(sessionStorage.getItem("eventexist")){
            updateTask(taskfrm);
        }
        else{
            insertTask(taskfrm);
        }
        window.location.replace("schedule");
    }
    function updateTask(taskfrm){
        var desc;
        var location;
        var eventToSave = {};
        var localevent = new Object();
        localevent.destination = taskfrm.destination.value; // formatted address for gCal
        localevent.description = taskfrm.description.value;
        localevent.title = taskfrm.taskTitle.value;
        localevent.id = sessionStorage.getItem("GeventId");//get original event id
        if (taskfrm.all_day.checked) {
            eventToSave = {
                'summary': localevent.title,
                'location': localevent.destination,
                'description': localevent.description,
                'start': {
                    'date': taskfrm.f_date.value
                },
                'end': {
                    'date': taskfrm.t_date.value
                }
            };
            localevent.start = taskfrm.f_date.value;
            localevent.end = taskfrm.t_date.value;
        } else {
            var f_dateTime = taskfrm.f_date.value + "T" + taskfrm.f_time.value + taskfrm.timezone;
            var t_dateTime = taskfrm.t_date.value + "T" + taskfrm.t_time.value + taskfrm.timezone;
            eventToSave = {
                'summary': localevent.title,
                'location': localevent.destination,
                'description': localevent.description,
                'start': {
                    'dateTime': f_dateTime
                },
                'end': {
                    'dateTime': t_dateTime
                }
            };
            localevent.start = f_dateTime;
            localevent.end = t_dateTime;
        }
        console.log(eventToSave);
        console.log(localevent);
        var request = gapi.client.calendar.events.update({
            'calendarId': 'primary',
            'eventId': localevent.id,
            'resource': eventToSave
        });
        request.execute(function(response) {
            if (!response) {
                console.log('error updating event');
                console.log(response);
            } else {
                console.log('event updated');
                console.log(response);
                $('#calendar').fullCalendar('updateEvent', localevent); // stick? = true                         
            }
        });
    }

</script>
<body>
    <script async defer src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
    <p>{{taskTitle}} </p>
    <form id="taskform" method="POST">
        {% csrf_token %}
        <input type="text" name="taskTitle" placeholder="Enter title of task">
        <input type="button" name="saveBtn" value="Save" onclick="saveTask()">
        <input type="button" name="delBtn" value="Delete" onclick="deleteTask()">
        <br>
        From: <input type="date" name="f_date" >
        <input list="f_time" name="f_time" ></label>
        <datalist id="f_time">
            <option value="1:00">
            <option value="2:00">
            <option value="3:00">
            <option value="4:00">
            <option value="5:00">
            <option value="6:00">
        </datalist>
        <!-- TODO using JS to set constraints for time input, and autoset t_time as f_time + 1hour-->
        <!-- CANDO using JS to recreate entire time list, so performance won't vary from browser-->
        To: <input type="date" name="t_date">
        <input list="t_time" name="t_time">
        <datalist id="t_time">
            <option value="1:00">
            <option value="2:00">
            <option value="3:00">
            <option value="4:00">
            <option value="5:00">
            <option value="6:00">
        </datalist>
        <br>
        <label for="Allday">all day</label>
        <input type="checkbox" name="all_day" onclick="isallday()">
        <label for="EventType">EventType</label>
        <select name="type" id="type">
            <option value="others">others</option>
            <option value="mealtime">mealtime</option>
            <option value="movie">movie</option>
        </select>
        <input type="text" name="destination" placeholder="Enter destination of task">
        <input type="textfield" name="description" placeholder="Enter description of task">
        <button type="button" name="cancelBtn">Cancel</button>
    </form>
</body>
</html>